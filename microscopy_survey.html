<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXxPhK7EYxHSI3gqK-aCFFKb594y_sF4ZAsba6LAfxdqoz-4TnHA8lDOXaKy0u8RkNtw/exec";

  document.getElementById('surveyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const answerField = document.getElementById('answer');
    const answer = answerField.value.trim();
    if (!answer) return alert("Please enter a response!");

    const submitButton = this.querySelector('button');
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = SCRIPT_URL;
    form.target = 'hidden-iframe';
    form.style.display = 'none';

    const answerInput = document.createElement('input');
    answerInput.type = 'text';
    answerInput.name = 'answer';
    answerInput.value = answer;
    form.appendChild(answerInput);
    document.body.appendChild(form);

    let iframe = document.getElementById('hidden-iframe');
    if (!iframe) {
      iframe = document.createElement('iframe');
      iframe.name = 'hidden-iframe';
      iframe.id = 'hidden-iframe';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
    }

    form.submit();
    setTimeout(() => document.body.removeChild(form), 1000);

    new Promise(resolve => setTimeout(resolve, 1000)).then(() => {
      answerField.value = '';
      document.getElementById('successMessage').style.display = 'block';
      setTimeout(() => document.getElementById('successMessage').style.display = 'none', 3000);
      submitButton.disabled = false;
      submitButton.textContent = 'Submit';
      fetchData();
    });
  });

  async function fetchData() {
    try {
      document.getElementById('loading').style.display = 'block';
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Math.round(Math.random() * 1000000);
        window[callbackName] = function(data) {
          console.log("DATA RECEIVED FROM SHEET:", data);
          processData(data);
          delete window[callbackName];
          document.body.removeChild(script);
          document.getElementById('loading').style.display = 'none';
          resolve();
        };

        const script = document.createElement('script');
        script.src = `${SCRIPT_URL}?callback=${callbackName}&_=${Date.now()}`;
        script.onerror = () => {
          document.getElementById('loading').style.display = 'none';
          delete window[callbackName];
          document.body.removeChild(script);
          console.error('Failed to load data from Google Apps Script');
          reject(new Error('Failed to load data'));
        };
        document.body.appendChild(script);
      });
    } catch (error) {
      console.error('Error fetching data:', error);
      document.getElementById('loading').style.display = 'none';
    }
  }

  function processData(data) {
    if (!Array.isArray(data) || data.length === 0) {
      document.getElementById('responseCount').textContent = 'Total responses: 0';
      document.getElementById('wordcloud').innerHTML = '<p style="text-align:center;padding-top:180px;color:#666;">Waiting for responses...</p>';
      return;
    }

    document.getElementById('responseCount').textContent = `Total responses: ${data.length}`;

    const stopWords = new Set([
      "and", "the", "of", "in", "a", "to", "with", "for", "on", "as", "by",
      "this", "that", "an", "at", "from", "is", "are", "be", "will", "or",
      "i", "we", "our", "it", "its", "they", "them", "their", "there", "these",
      "those", "am", "was", "were", "been", "being", "have", "has", "had",
      "do", "does", "did", "but", "if", "then", "else", "when",
      "up", "down", "out", "over", "under", "again", "further", "once",
      "can", "could", "may", "might", "must", "should", "would"
    ]);

    const words = data
      .flatMap(text => text.split(/[ ,;/\n.()\[\]{}]+/))
      .map(word => word.trim().toLowerCase())
      .filter(word => word.length > 0 && !stopWords.has(word));

    if (words.length === 0) {
      document.getElementById('wordcloud').innerHTML = '<p style="text-align:center;padding-top:180px;color:#999;">No meaningful words yet.</p>';
      return;
    }

    const freq = {};
    words.forEach(word => {
      freq[word] = (freq[word] || 0) + 1;
    });

    const wordArray = Object.entries(freq)
      .map(([text, weight]) => [text.toUpperCase(), weight])
      .sort((a, b) => b[1] - a[1]);

    const cloudElement = document.getElementById('wordcloud');
    cloudElement.innerHTML = '';

    const colorPalette = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFD740', '#FFAB40', '#FF6E40'];

    WordCloud(cloudElement, {
      list: wordArray,
      gridSize: 6,
      weightFactor: size => Math.sqrt(size) * 14,
      rotateRatio: 0.7,
      rotationSteps: 8,
      fontFamily: 'Impact, Arial Black, sans-serif',
      color: () => colorPalette[Math.floor(Math.random() * colorPalette.length)],
      drawOutOfBound: false,
      shrinkToFit: true,
      minSize: 14,
      backgroundColor: '#fff',
      shuffle: true,
      clearCanvas: true
    });
  }

  // Slight delay on first fetch to ensure everything loads
  setTimeout(fetchData, 500);
  setInterval(fetchData, 120000);
</script>
